<dom-module id="account-transactions">
	<template>
		<style include="app-styles">
		</style>
		
<!--
		<burst-api
				   params="{{_getTransactionParams(id)}}"
				   response="{{transactions}}"
				   ></burst-api>
-->
        <paper-card>

            <!--   data-provider="{{accountTransactionsProvider}}" size="{{}}" -->
            <vaadin-grid id="accountTransactionGrid" aria-label="Transactions" data-provider="{{accountTransactionsProvider}}" size="100">
                <vaadin-grid-column>
                    <template class="header">Time</template>
                    <template>
                        {{_time(item.timestamp)}}
                    </template>
                </vaadin-grid-column>
                
                <vaadin-grid-column>
                    <template class="header">Transaction</template>
                    <template>
                        <a href="/transaction/{{item._id}}" on-tap="_tableClick">{{item._id}}</a>
                    </template>
                </vaadin-grid-column>
                
                <vaadin-grid-column>
                    <template class="header">From</template>
                    <template>
                        <a href="/account/{{item.sender}}" on-tap="_tableClick">{{item.senderRS}}</a>
                    </template>
                </vaadin-grid-column>
                
                <vaadin-grid-column>
                    <template class="header">Amount</template>
                    <template>
                        <span class$="{{_txColor(item.sender)}}">{{_formatNQT(item.amountNQT)}}<small class="thin">{{_NQTDecimals(item.amountNQT)}} <b>ATM</b></small></span>
                    </template>
                </vaadin-grid-column>
                
                <vaadin-grid-column>
                    <template class="header">To</template>
                    <template>
                        <a href="/account/{{item.recipient}}" on-tap="_tableClick">{{item.recipientRS}}</a>
                    </template>
                </vaadin-grid-column>
                
                <vaadin-grid-column>
                    <template class="header">Type</template>
                    <template>
                        <span>{{_txType(item.type, item.subtype)}}</span>
                    </template>
                </vaadin-grid-column>
                
                <vaadin-grid-column>
                    <template class="header">Block height</template>
                    <template>
                        <a href="/block/{{item.block}}">{{_format(item.ecBlockHeight)}}</a>
                    </template>
                </vaadin-grid-column>
            </vaadin-grid>
        </paper-card>
		
	</template>
	<script>
        const transactionsDB  = new PouchDB(DB_URL + '/transactions');
        
		Polymer({
			is: "account-transactions",
			
			properties: {
				id: {
					type: String,
					observer: "_idObserver"
				},
				txSource: {
					type: Object,
					computed: "_txSource(id)"
				},
				route:{
					notify: true
				}
			},
			
			_getTransactionParams: function(id){
				return {
					requestType: "getAccountTransactions",
					lastIndex: 50,
					account: id
				};
			},
			
			_refreshTx: function(){
				this.$.transactionsCard.firstPage();
				this.$.transactionsCard.retrieveVisibleData();
			},

			_tableClick: function(e){
				console.log(e);
				//this.set('route.path', e.srcElement.href);
			},

			_txColor: function(sender){
				if(sender == this.id){
					return "red-text";
				}
				return "green-text";
			},
			
			_time: function(timestamp){
				timestamp += 1407722400
				var a = new Date(timestamp*1000);
				var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
				var year = a.getFullYear();
				var month = months[a.getMonth()];
				var date = a.getDate();
				var hour = a.getHours();
				var min = a.getMinutes();
				//var sec = a.getSeconds();
				// Will display time in 10:30:23 format
				var time = hour + ':' + min + ' ' + date + ' ' + month + ' ' + ' ' + year;
				return time;
			},
			_txType: function(type, subtype){
				//console.log(type +" "+ subtype)
				return txTypes[type][subtype];
			},
			_format: function(num){
				return num.toLocaleString();
			},

			_formatNQT: function(num){
				num =  parseFloat((num / 100000000).toFixed(0));
				return num.toLocaleString();
			},
			_NQTDecimals: function(num){
				return "." + (
					parseFloat((num / 100000000).toFixed(0)) - parseFloat((num / 100000000).toFixed(8))
				).toString().slice(-8);
			},
			

			_idObserver: function(){
				//this.$.transactionsCard.firstPage();
			},

			ready: function(){
				setInterval(function(){
					//this.$.transactionsCard.retrieveVisibleData();
				}.bind(this),60 * 1000);
                
                const ID = this.id;
                
                this.accountTransactionsProvider = (params, callback) => {
                    var options = {
                        selector: {
                            $or: [
                                {recipient: ID},
                                {sender: ID}
                            ]
                        },
                        fields:["_id", "timestamp", "sender", "senderRS","recipient", "recipientRS", "block", "ecBlockHeight", "amountNQT", "type", "subtype"],
                        skip: params.pageSize*(params.page),
                        limit: params.pageSize
                    }
                    
                    console.log(options);
                    transactionsDB.find(options)
                        .then(function(response){
                        console.log(response);
                        var docs = response.docs.map(function(transaction){
                            return transaction;
                        });
                        //console.log(docs)
                        callback(docs);
                    })
                        .catch(err => {
                        console.log(err);
                    })
                };
                
                    
            }
        });
	</script>
</dom-module>
